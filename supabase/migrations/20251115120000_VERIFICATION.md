# V√©rification Migration: Make supplier_company_id nullable

## Migration File
`20251115120000_make_supplier_company_id_nullable.sql`

## Objectif
Rendre la colonne `supplier_company_id` nullable dans `poc_purchase_orders` pour supporter les commandes BCI (internes) sans fournisseur.

---

## ‚úÖ Checklist de V√©rification

### 1. V√©rifier que la colonne est nullable

```sql
SELECT 
  column_name, 
  is_nullable, 
  data_type,
  column_default
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'poc_purchase_orders' 
  AND column_name = 'supplier_company_id';
```

**R√©sultat attendu:**
- `is_nullable` = `'YES'`
- `data_type` = `'uuid'`

---

### 2. V√©rifier que la contrainte CHECK existe

```sql
SELECT 
  constraint_name, 
  check_clause
FROM information_schema.check_constraints
WHERE constraint_schema = 'public'
  AND constraint_name = 'check_supplier_by_order_type';
```

**R√©sultat attendu:**
- Constrainte existe
- `check_clause` contient la logique pour BCI/BCE

---

### 3. V√©rifier que le trigger existe

```sql
SELECT 
  trigger_name, 
  event_manipulation, 
  event_object_table,
  action_statement
FROM information_schema.triggers
WHERE trigger_schema = 'public'
  AND trigger_name = 'validate_poc_purchase_order_supplier_type_trigger';
```

**R√©sultat attendu:**
- Trigger existe
- `event_manipulation` = `'INSERT'` ou `'UPDATE'`

---

### 4. V√©rifier que l'ancienne contrainte est supprim√©e

```sql
SELECT 
  constraint_name
FROM information_schema.table_constraints
WHERE constraint_schema = 'public'
  AND table_name = 'poc_purchase_orders'
  AND constraint_name = 'check_supplier_is_supplier';
```

**R√©sultat attendu:**
- Aucune ligne retourn√©e (contrainte supprim√©e)

---

## üß™ Tests Fonctionnels

### Test 1: Cr√©er une commande BCI (devrait r√©ussir)

```sql
-- Remplacer les IDs par des valeurs valides de votre base
INSERT INTO public.poc_purchase_orders (
  order_number, 
  buyer_company_id, 
  order_type, 
  org_unit_id, 
  created_by,
  status
) VALUES (
  'TEST-BCI-001',
  (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1),
  'BCI',
  (SELECT id FROM poc_org_units LIMIT 1),
  (SELECT id FROM auth.users LIMIT 1),
  'draft'
)
RETURNING id, order_number, order_type, supplier_company_id, org_unit_id;
```

**R√©sultat attendu:**
- ‚úÖ INSERT r√©ussit
- `supplier_company_id` = `NULL`
- `order_type` = `'BCI'`
- `org_unit_id` est d√©fini

---

### Test 2: Cr√©er une commande BCE sans supplier (devrait √©chouer)

```sql
INSERT INTO public.poc_purchase_orders (
  order_number, 
  buyer_company_id, 
  order_type, 
  project_id, 
  created_by,
  status
) VALUES (
  'TEST-BCE-FAIL-001',
  (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1),
  'BCE',
  (SELECT id FROM poc_projects LIMIT 1),
  (SELECT id FROM auth.users LIMIT 1),
  'draft'
);
```

**R√©sultat attendu:**
- ‚ùå INSERT √©choue avec erreur CHECK constraint violation
- Message d'erreur mentionne `check_supplier_by_order_type`

---

### Test 3: Cr√©er une commande BCE avec supplier (devrait r√©ussir)

```sql
INSERT INTO public.poc_purchase_orders (
  order_number, 
  buyer_company_id, 
  supplier_company_id,
  order_type, 
  project_id, 
  created_by,
  status
) VALUES (
  'TEST-BCE-002',
  (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1),
  (SELECT id FROM poc_companies WHERE type = 'supplier' LIMIT 1),
  'BCE',
  (SELECT id FROM poc_projects LIMIT 1),
  (SELECT id FROM auth.users LIMIT 1),
  'draft'
)
RETURNING id, order_number, order_type, supplier_company_id, project_id;
```

**R√©sultat attendu:**
- ‚úÖ INSERT r√©ussit
- `supplier_company_id` est d√©fini
- `order_type` = `'BCE'`
- `project_id` est d√©fini

---

### Test 4: V√©rifier les commandes existantes

```sql
-- Compter les commandes par type
SELECT 
  order_type,
  COUNT(*) as total,
  COUNT(supplier_company_id) as with_supplier,
  COUNT(*) - COUNT(supplier_company_id) as without_supplier
FROM public.poc_purchase_orders
GROUP BY order_type
ORDER BY order_type;
```

**R√©sultat attendu:**
- Commandes `BCE` ont toutes un `supplier_company_id`
- Commandes `BCI` n'ont pas de `supplier_company_id` (NULL)
- Pas de commandes avec `order_type` NULL (mises √† jour par la migration)

---

### Test 5: V√©rifier la contrainte de type supplier

```sql
-- Tenter d'ins√©rer une commande BCE avec un supplier qui n'est pas de type 'supplier'
-- (devrait √©chouer via le trigger)
INSERT INTO public.poc_purchase_orders (
  order_number, 
  buyer_company_id, 
  supplier_company_id,
  order_type, 
  project_id, 
  created_by,
  status
) VALUES (
  'TEST-BCE-INVALID-SUPPLIER',
  (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1),
  (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1), -- Builder au lieu de Supplier
  'BCE',
  (SELECT id FROM poc_projects LIMIT 1),
  (SELECT id FROM auth.users LIMIT 1),
  'draft'
);
```

**R√©sultat attendu:**
- ‚ùå INSERT √©choue avec erreur du trigger
- Message: `supplier_company_id must reference a company of type 'supplier'`

---

## üìä Statistiques Post-Migration

```sql
-- Vue d'ensemble des commandes
SELECT 
  'Total commandes' as metric,
  COUNT(*)::text as value
FROM public.poc_purchase_orders
UNION ALL
SELECT 
  'Commandes BCI',
  COUNT(*)::text
FROM public.poc_purchase_orders
WHERE order_type = 'BCI'
UNION ALL
SELECT 
  'Commandes BCE',
  COUNT(*)::text
FROM public.poc_purchase_orders
WHERE order_type = 'BCE'
UNION ALL
SELECT 
  'BCI avec supplier (ERREUR)',
  COUNT(*)::text
FROM public.poc_purchase_orders
WHERE order_type = 'BCI' AND supplier_company_id IS NOT NULL
UNION ALL
SELECT 
  'BCE sans supplier (ERREUR)',
  COUNT(*)::text
FROM public.poc_purchase_orders
WHERE order_type = 'BCE' AND supplier_company_id IS NULL;
```

**R√©sultat attendu:**
- Les deux derni√®res lignes doivent retourner `0` (aucune erreur de coh√©rence)

---

## üîÑ Rollback (si n√©cessaire)

Si vous devez annuler la migration, ex√©cutez:

```sql
-- ATTENTION: Cela √©chouera s'il y a des commandes BCI avec supplier_company_id = NULL
\i supabase/migrations/20251115120000_make_supplier_company_id_nullable_ROLLBACK.sql
```

**Pr√©requis pour rollback:**
- Supprimer ou convertir toutes les commandes BCI existantes
- Ou mettre √† jour les commandes BCI pour leur donner un `supplier_company_id` (les convertir en BCE)

---

## ‚úÖ R√©sum√©

Apr√®s avoir ex√©cut√© tous les tests ci-dessus, vous devriez avoir:

- [x] Colonne `supplier_company_id` est nullable
- [x] Contrainte `check_supplier_by_order_type` existe et fonctionne
- [x] Trigger `validate_poc_purchase_order_supplier_type_trigger` existe
- [x] Ancienne contrainte `check_supplier_is_supplier` est supprim√©e
- [x] Cr√©ation de commandes BCI sans supplier fonctionne
- [x] Cr√©ation de commandes BCE sans supplier √©choue (comme pr√©vu)
- [x] Cr√©ation de commandes BCE avec supplier fonctionne
- [x] Aucune incoh√©rence dans les donn√©es existantes

---

**Date de v√©rification:** _______________  
**V√©rifi√© par:** _______________  
**Statut:** ‚òê Succ√®s  ‚òê √âchec  ‚òê Partiel




