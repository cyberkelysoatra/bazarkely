# V√©rification Migration: Add company_id to poc_org_unit_members

## Migration File
`20251115130000_add_company_id_to_org_unit_members.sql`

## Objectif
Ajouter la colonne `company_id` √† la table `poc_org_unit_members` pour permettre le filtrage direct par compagnie dans les requ√™tes (utilis√© par PurchaseOrderForm.tsx ligne 252).

---

## ‚úÖ Checklist de V√©rification

### 1. V√©rifier que la colonne existe

```sql
SELECT 
  column_name, 
  data_type, 
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'poc_org_unit_members' 
  AND column_name = 'company_id';
```

**R√©sultat attendu:**
- `column_name` = `'company_id'`
- `data_type` = `'uuid'`
- `is_nullable` = `'NO'` (ou `'YES'` si des enregistrements orphelins existent)

---

### 2. V√©rifier que la contrainte de cl√© √©trang√®re existe

```sql
SELECT 
  constraint_name, 
  table_name,
  constraint_type
FROM information_schema.table_constraints
WHERE constraint_schema = 'public'
  AND table_name = 'poc_org_unit_members'
  AND constraint_name = 'fk_org_unit_members_company';
```

**R√©sultat attendu:**
- Constrainte existe
- `constraint_type` = `'FOREIGN KEY'`

---

### 3. V√©rifier que les index sont cr√©√©s

```sql
SELECT 
  indexname,
  indexdef
FROM pg_indexes
WHERE schemaname = 'public'
  AND tablename = 'poc_org_unit_members'
  AND indexname LIKE '%company%'
ORDER BY indexname;
```

**R√©sultat attendu:**
- 4 index avec 'company' dans le nom:
  - `idx_poc_org_unit_members_company_id`
  - `idx_poc_org_unit_members_company_user_status`
  - `idx_poc_org_unit_members_company_org_unit`
  - `idx_poc_org_unit_members_company_active`

---

### 4. V√©rifier l'int√©grit√© des donn√©es

```sql
-- V√©rifier que tous les membres ont un company_id
SELECT 
  COUNT(*) as total_members,
  COUNT(company_id) as members_with_company_id,
  COUNT(*) - COUNT(company_id) as members_without_company_id
FROM public.poc_org_unit_members;
```

**R√©sultat attendu:**
- `members_without_company_id` = `0` (tous les membres ont un company_id)

---

### 5. V√©rifier que company_id correspond √† org_unit.company_id

```sql
-- V√©rifier la coh√©rence entre company_id et org_unit.company_id
SELECT 
  COUNT(*) as total_members,
  COUNT(CASE WHEN m.company_id = u.company_id THEN 1 END) as matching_company_id,
  COUNT(CASE WHEN m.company_id != u.company_id THEN 1 END) as mismatched_company_id
FROM public.poc_org_unit_members m
INNER JOIN public.poc_org_units u ON m.org_unit_id = u.id;
```

**R√©sultat attendu:**
- `mismatched_company_id` = `0` (tous les company_id correspondent)

---

## üß™ Tests Fonctionnels

### Test 1: Requ√™te depuis PurchaseOrderForm (devrait r√©ussir)

```sql
-- Simuler la requ√™te de PurchaseOrderForm.tsx ligne 252
-- Remplacer les UUIDs par des valeurs valides de votre base
SELECT 
  org_unit_id,
  user_id,
  role,
  status,
  company_id
FROM public.poc_org_unit_members
WHERE user_id = (SELECT id FROM auth.users LIMIT 1)
  AND status = 'active'
  AND company_id = (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1);
```

**R√©sultat attendu:**
- ‚úÖ Requ√™te r√©ussit sans erreur
- Retourne les `org_unit_id` correspondants
- `company_id` est pr√©sent dans les r√©sultats

---

### Test 2: V√©rifier les performances avec index

```sql
-- Test d'explain pour v√©rifier que l'index est utilis√©
EXPLAIN ANALYZE
SELECT org_unit_id 
FROM public.poc_org_unit_members 
WHERE company_id = (SELECT id FROM poc_companies WHERE type = 'builder' LIMIT 1)
  AND status = 'active';
```

**R√©sultat attendu:**
- Plan d'ex√©cution utilise l'index `idx_poc_org_unit_members_company_active`
- Temps d'ex√©cution rapide

---

### Test 3: V√©rifier la contrainte de cl√© √©trang√®re

```sql
-- Tenter d'ins√©rer un company_id invalide (devrait √©chouer)
INSERT INTO public.poc_org_unit_members (
  org_unit_id,
  user_id,
  role,
  status,
  company_id
) VALUES (
  (SELECT id FROM poc_org_units LIMIT 1),
  (SELECT id FROM auth.users LIMIT 1),
  'chef_equipe',
  'active',
  '00000000-0000-0000-0000-000000000000' -- UUID invalide
);
```

**R√©sultat attendu:**
- ‚ùå INSERT √©choue avec erreur de contrainte de cl√© √©trang√®re
- Message: `violates foreign key constraint "fk_org_unit_members_company"`

---

### Test 4: V√©rifier la coh√©rence apr√®s insertion

```sql
-- Ins√©rer un nouveau membre et v√©rifier que company_id est coh√©rent
INSERT INTO public.poc_org_unit_members (
  org_unit_id,
  user_id,
  role,
  status
) 
SELECT 
  ou.id,
  u.id,
  'chef_equipe',
  'active'
FROM poc_org_units ou
CROSS JOIN auth.users u
LIMIT 1
RETURNING id, org_unit_id, company_id;

-- V√©rifier que company_id correspond √† org_unit.company_id
SELECT 
  m.id,
  m.company_id as member_company_id,
  u.company_id as org_unit_company_id,
  CASE 
    WHEN m.company_id = u.company_id THEN 'OK'
    ELSE 'ERREUR'
  END as status
FROM public.poc_org_unit_members m
INNER JOIN public.poc_org_units u ON m.org_unit_id = u.id
WHERE m.id = (SELECT id FROM public.poc_org_unit_members ORDER BY created_at DESC LIMIT 1);
```

**R√©sultat attendu:**
- `status` = `'OK'` (company_id correspond)

**Note:** Si le company_id n'est pas automatiquement rempli lors de l'insertion, il faudra cr√©er un trigger pour le faire automatiquement.

---

### Test 5: V√©rifier les RLS policies

```sql
-- V√©rifier que les policies RLS existantes fonctionnent toujours
SELECT 
  policyname,
  cmd,
  CASE 
    WHEN qual LIKE '%company_id%' THEN 'Utilise company_id'
    ELSE 'N''utilise pas company_id directement'
  END as uses_company_id
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename = 'poc_org_unit_members';
```

**R√©sultat attendu:**
- Les policies existantes continuent de fonctionner
- Optionnel: Les policies peuvent √™tre optimis√©es pour utiliser `company_id` directement

---

## üìä Statistiques Post-Migration

```sql
-- Vue d'ensemble des donn√©es
SELECT 
  'Total membres' as metric,
  COUNT(*)::text as value
FROM public.poc_org_unit_members
UNION ALL
SELECT 
  'Membres avec company_id',
  COUNT(company_id)::text
FROM public.poc_org_unit_members
UNION ALL
SELECT 
  'Membres sans company_id (ERREUR)',
  (COUNT(*) - COUNT(company_id))::text
FROM public.poc_org_unit_members
UNION ALL
SELECT 
  'Company IDs uniques',
  COUNT(DISTINCT company_id)::text
FROM public.poc_org_unit_members
WHERE company_id IS NOT NULL
UNION ALL
SELECT 
  'Incoh√©rences company_id (ERREUR)',
  COUNT(*)::text
FROM public.poc_org_unit_members m
INNER JOIN public.poc_org_units u ON m.org_unit_id = u.id
WHERE m.company_id != u.company_id;
```

**R√©sultat attendu:**
- Les deux derni√®res lignes doivent retourner `0` (aucune erreur)

---

## üîÑ Rollback (si n√©cessaire)

Si vous devez annuler la migration, ex√©cutez:

```sql
\i supabase/migrations/20251115130000_add_company_id_to_org_unit_members_ROLLBACK.sql
```

**Pr√©requis pour rollback:**
- V√©rifier qu'aucun code ne d√©pend de la colonne `company_id`
- S'assurer que les requ√™tes peuvent fonctionner sans cette colonne

---

## üöÄ Optimisation Future (Optionnel)

Pour maintenir automatiquement `company_id` lors des insertions/updates, cr√©er un trigger:

```sql
-- Trigger pour maintenir company_id automatiquement
CREATE OR REPLACE FUNCTION public.sync_org_unit_member_company_id()
RETURNS TRIGGER AS $$
BEGIN
  -- Si company_id n'est pas fourni, le d√©river de org_unit_id
  IF NEW.company_id IS NULL AND NEW.org_unit_id IS NOT NULL THEN
    SELECT company_id INTO NEW.company_id
    FROM public.poc_org_units
    WHERE id = NEW.org_unit_id;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER sync_org_unit_member_company_id_trigger
  BEFORE INSERT OR UPDATE OF org_unit_id ON public.poc_org_unit_members
  FOR EACH ROW
  EXECUTE FUNCTION public.sync_org_unit_member_company_id();
```

---

## ‚úÖ R√©sum√©

Apr√®s avoir ex√©cut√© tous les tests ci-dessus, vous devriez avoir:

- [x] Colonne `company_id` existe dans `poc_org_unit_members`
- [x] Contrainte de cl√© √©trang√®re `fk_org_unit_members_company` existe
- [x] 4 index cr√©√©s pour les performances
- [x] Tous les enregistrements existants ont un `company_id` valide
- [x] `company_id` correspond √† `org_unit.company_id` pour tous les enregistrements
- [x] Requ√™te depuis PurchaseOrderForm.tsx fonctionne sans erreur
- [x] RLS policies continuent de fonctionner

---

**Date de v√©rification:** _______________  
**V√©rifi√© par:** _______________  
**Statut:** ‚òê Succ√®s  ‚òê √âchec  ‚òê Partiel






