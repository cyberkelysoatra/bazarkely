<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Persistance des DonnÃ©es - BazarKELY</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .data-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Diagnostic Persistance des DonnÃ©es - BazarKELY</h1>
        
        <div class="info">
            <h3>ğŸ“‹ Instructions</h3>
            <p>1. Cliquez sur "Analyser la Base de DonnÃ©es" pour voir l'Ã©tat actuel</p>
            <p>2. Testez la persistance en crÃ©ant des donnÃ©es de test</p>
            <p>3. VÃ©rifiez que les donnÃ©es persistent aprÃ¨s rechargement</p>
        </div>

        <button onclick="analyzeDatabase()">ğŸ” Analyser la Base de DonnÃ©es</button>
        <button onclick="createTestData()">ğŸ§ª CrÃ©er des DonnÃ©es de Test</button>
        <button onclick="testPersistence()">ğŸ”„ Tester la Persistance</button>
        <button onclick="clearTestData()">ğŸ—‘ï¸ Nettoyer les DonnÃ©es de Test</button>

        <div id="results"></div>
    </div>

    <script type="module">
        // Import des modules nÃ©cessaires
        import { db } from './lib/database.js';
        import authService from './services/authService.js';

        // Fonction pour afficher les rÃ©sultats
        function displayResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `data-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            resultsDiv.appendChild(div);
        }

        // Analyser la base de donnÃ©es
        window.analyzeDatabase = async function() {
            try {
                displayResult('ğŸ” Analyse de la Base de DonnÃ©es', 'Analyse en cours...', 'info');
                
                // Compter les utilisateurs
                const userCount = await db.users.count();
                const users = await db.users.toArray();
                
                // Compter les comptes
                const accountCount = await db.accounts.count();
                const accounts = await db.accounts.toArray();
                
                // Compter les transactions
                const transactionCount = await db.transactions.count();
                const transactions = await db.transactions.toArray();
                
                // Compter les budgets
                const budgetCount = await db.budgets.count();
                const budgets = await db.budgets.toArray();
                
                // Compter les objectifs
                const goalCount = await db.goals.count();
                const goals = await db.goals.toArray();

                let analysis = `ğŸ“Š STATISTIQUES GÃ‰NÃ‰RALES:\n`;
                analysis += `Utilisateurs: ${userCount}\n`;
                analysis += `Comptes: ${accountCount}\n`;
                analysis += `Transactions: ${transactionCount}\n`;
                analysis += `Budgets: ${budgetCount}\n`;
                analysis += `Objectifs: ${goalCount}\n\n`;

                if (users.length > 0) {
                    analysis += `ğŸ‘¥ UTILISATEURS:\n`;
                    users.forEach(user => {
                        analysis += `- ${user.username} (ID: ${user.id})\n`;
                        analysis += `  Email: ${user.email}\n`;
                        analysis += `  CrÃ©Ã©: ${user.createdAt}\n\n`;
                    });
                }

                if (accounts.length > 0) {
                    analysis += `ğŸ’³ COMPTES:\n`;
                    accounts.forEach(account => {
                        analysis += `- ${account.name} (${account.type}) - ${account.balance} MGA\n`;
                        analysis += `  Utilisateur: ${account.userId}\n\n`;
                    });
                }

                if (transactions.length > 0) {
                    analysis += `ğŸ’° TRANSACTIONS (5 derniÃ¨res):\n`;
                    const recentTransactions = transactions.slice(-5);
                    recentTransactions.forEach(transaction => {
                        analysis += `- ${transaction.description}: ${transaction.amount} MGA\n`;
                        analysis += `  Type: ${transaction.type} | Utilisateur: ${transaction.userId}\n\n`;
                    });
                }

                displayResult('âœ… Analyse TerminÃ©e', analysis, 'success');
                
            } catch (error) {
                displayResult('âŒ Erreur d\'Analyse', error.message, 'error');
            }
        };

        // CrÃ©er des donnÃ©es de test
        window.createTestData = async function() {
            try {
                displayResult('ğŸ§ª CrÃ©ation des DonnÃ©es de Test', 'CrÃ©ation en cours...', 'info');
                
                // CrÃ©er un utilisateur de test
                const testUser = await authService.findOrCreateUser('testuser', {
                    email: 'test@example.com',
                    phone: '+261 34 00 000 00'
                });

                // CrÃ©er des comptes de test
                const testAccount1 = {
                    id: crypto.randomUUID(),
                    userId: testUser.id,
                    name: 'Compte Test 1',
                    type: 'especes',
                    balance: 100000,
                    currency: 'MGA',
                    createdAt: new Date()
                };

                const testAccount2 = {
                    id: crypto.randomUUID(),
                    userId: testUser.id,
                    name: 'Compte Test 2',
                    type: 'orange_money',
                    balance: 50000,
                    currency: 'MGA',
                    createdAt: new Date()
                };

                await db.accounts.bulkAdd([testAccount1, testAccount2]);

                // CrÃ©er des transactions de test
                const testTransactions = [
                    {
                        id: crypto.randomUUID(),
                        userId: testUser.id,
                        accountId: testAccount1.id,
                        type: 'income',
                        amount: 50000,
                        description: 'Test Revenu',
                        category: 'salaire',
                        date: new Date(),
                        createdAt: new Date()
                    },
                    {
                        id: crypto.randomUUID(),
                        userId: testUser.id,
                        accountId: testAccount1.id,
                        type: 'expense',
                        amount: -25000,
                        description: 'Test DÃ©pense',
                        category: 'nourriture',
                        date: new Date(),
                        createdAt: new Date()
                    },
                    {
                        id: crypto.randomUUID(),
                        userId: testUser.id,
                        accountId: testAccount1.id,
                        type: 'transfer',
                        amount: -10000,
                        description: 'Test Transfert',
                        category: 'autres',
                        date: new Date(),
                        targetAccountId: testAccount2.id,
                        createdAt: new Date()
                    }
                ];

                await db.transactions.bulkAdd(testTransactions);

                displayResult('âœ… DonnÃ©es de Test CrÃ©Ã©es', 
                    `Utilisateur: ${testUser.username} (${testUser.id})\n` +
                    `Comptes: 2\n` +
                    `Transactions: 3\n\n` +
                    `Rechargez la page pour tester la persistance.`, 
                    'success');

            } catch (error) {
                displayResult('âŒ Erreur de CrÃ©ation', error.message, 'error');
            }
        };

        // Tester la persistance
        window.testPersistence = async function() {
            try {
                displayResult('ğŸ”„ Test de Persistance', 'Test en cours...', 'info');
                
                // VÃ©rifier si les donnÃ©es existent toujours
                const userCount = await db.users.count();
                const accountCount = await db.accounts.count();
                const transactionCount = await db.transactions.count();

                let testResult = `ğŸ“Š DONNÃ‰ES ACTUELLES:\n`;
                testResult += `Utilisateurs: ${userCount}\n`;
                testResult += `Comptes: ${accountCount}\n`;
                testResult += `Transactions: ${transactionCount}\n\n`;

                if (userCount > 0) {
                    const users = await db.users.toArray();
                    testResult += `ğŸ‘¥ UTILISATEURS TROUVÃ‰S:\n`;
                    users.forEach(user => {
                        testResult += `- ${user.username} (ID: ${user.id})\n`;
                    });
                    testResult += `\n`;
                }

                if (accountCount > 0) {
                    const accounts = await db.accounts.toArray();
                    testResult += `ğŸ’³ COMPTES TROUVÃ‰S:\n`;
                    accounts.forEach(account => {
                        testResult += `- ${account.name} (${account.type}) - ${account.balance} MGA\n`;
                    });
                    testResult += `\n`;
                }

                if (transactionCount > 0) {
                    const transactions = await db.transactions.toArray();
                    testResult += `ğŸ’° TRANSACTIONS TROUVÃ‰ES:\n`;
                    transactions.forEach(transaction => {
                        testResult += `- ${transaction.description}: ${transaction.amount} MGA\n`;
                    });
                }

                const isDataPersistent = userCount > 0 && accountCount > 0 && transactionCount > 0;
                
                displayResult(
                    isDataPersistent ? 'âœ… Persistance ConfirmÃ©e' : 'âŒ ProblÃ¨me de Persistance', 
                    testResult, 
                    isDataPersistent ? 'success' : 'error'
                );

            } catch (error) {
                displayResult('âŒ Erreur de Test', error.message, 'error');
            }
        };

        // Nettoyer les donnÃ©es de test
        window.clearTestData = async function() {
            try {
                displayResult('ğŸ—‘ï¸ Nettoyage des DonnÃ©es de Test', 'Nettoyage en cours...', 'info');
                
                // Supprimer l'utilisateur de test et toutes ses donnÃ©es
                const testUser = await authService.getUserByUsername('testuser');
                if (testUser) {
                    await authService.deleteUser(testUser.id);
                    displayResult('âœ… DonnÃ©es de Test SupprimÃ©es', 
                        `Utilisateur ${testUser.username} et toutes ses donnÃ©es ont Ã©tÃ© supprimÃ©s.`, 
                        'success');
                } else {
                    displayResult('â„¹ï¸ Aucune DonnÃ©e de Test', 
                        'Aucun utilisateur de test trouvÃ© Ã  supprimer.', 
                        'info');
                }

            } catch (error) {
                displayResult('âŒ Erreur de Nettoyage', error.message, 'error');
            }
        };

        // Analyser automatiquement au chargement
        window.addEventListener('load', () => {
            analyzeDatabase();
        });
    </script>
</body>
</html>
