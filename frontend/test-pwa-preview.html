<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PWA Preview - BazarKELY</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: rgba(34, 197, 94, 0.3); border: 1px solid #22c55e; }
        .error { background: rgba(239, 68, 68, 0.3); border: 1px solid #ef4444; }
        .info { background: rgba(59, 130, 246, 0.3); border: 1px solid #3b82f6; }
        .warning { background: rgba(245, 158, 11, 0.3); border: 1px solid #f59e0b; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #4338ca; }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test PWA Preview - BazarKELY</h1>
        <p>Cette page teste la fonctionnalit√© PWA pre-capture en mode production.</p>
        
        <div class="test-section">
            <h2>üìä Statut du Serveur</h2>
            <div id="server-status" class="status info">
                ‚è≥ V√©rification du serveur de pr√©visualisation...
            </div>
        </div>

        <div class="test-section">
            <h2>üåê Application Preview</h2>
            <p>L'application BazarKELY en mode production :</p>
            <iframe id="preview-frame" src="http://localhost:4173" title="BazarKELY Preview"></iframe>
        </div>

        <div class="test-section">
            <h2>üîß Tests PWA</h2>
            <div>
                <button onclick="testPWACapture()">Tester Pre-Capture</button>
                <button onclick="checkSessionStorage()">V√©rifier sessionStorage</button>
                <button onclick="clearSessionStorage()">Nettoyer sessionStorage</button>
                <button onclick="testInstallButton()">Tester Bouton Install</button>
            </div>
            <div id="pwa-status" class="status info">
                ‚è≥ En attente des tests PWA...
            </div>
        </div>

        <div class="test-section">
            <h2>üìù Logs de Test</h2>
            <div id="log" class="log">
                <div>üìù Logs de test :</div>
            </div>
        </div>
    </div>

    <script>
        // V√©rification du serveur au chargement
        window.addEventListener('load', async () => {
            await checkServerStatus();
        });

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:4173');
                if (response.ok) {
                    updateStatus('server-status', 'success', '‚úÖ Serveur de pr√©visualisation actif sur http://localhost:4173');
                    log('‚úÖ Serveur de pr√©visualisation accessible');
                } else {
                    updateStatus('server-status', 'error', '‚ùå Serveur de pr√©visualisation non accessible');
                    log('‚ùå Erreur serveur: ' + response.status);
                }
            } catch (error) {
                updateStatus('server-status', 'error', '‚ùå Serveur de pr√©visualisation non accessible');
                log('‚ùå Erreur de connexion: ' + error.message);
            }
        }

        function testPWACapture() {
            log('üîç Test de la fonctionnalit√© PWA pre-capture...');
            
            // Simuler la v√©rification du code pre-capture
            const previewFrame = document.getElementById('preview-frame');
            try {
                // V√©rifier si l'iframe peut acc√©der au contenu
                const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                log('‚úÖ Iframe accessible pour les tests');
                
                // V√©rifier la pr√©sence du code pre-capture dans la page
                const iframeContent = iframeDoc.documentElement.innerHTML;
                if (iframeContent.includes('capturePWAPrompt') || iframeContent.includes('bazarkely-pwa-prompt')) {
                    log('‚úÖ Code pre-capture PWA d√©tect√© dans l\'application');
                    updateStatus('pwa-status', 'success', '‚úÖ Code pre-capture PWA pr√©sent');
                } else {
                    log('‚ö†Ô∏è Code pre-capture PWA non d√©tect√© dans l\'application');
                    updateStatus('pwa-status', 'warning', '‚ö†Ô∏è Code pre-capture PWA non d√©tect√©');
                }
            } catch (error) {
                log('‚ùå Impossible d\'acc√©der au contenu de l\'iframe (CORS): ' + error.message);
                updateStatus('pwa-status', 'warning', '‚ö†Ô∏è Test limit√© par CORS');
            }
        }

        function checkSessionStorage() {
            log('üîç V√©rification du sessionStorage...');
            
            try {
                // V√©rifier les cl√©s PWA
                const pwaPrompt = sessionStorage.getItem('bazarkely-pwa-prompt');
                const oauthTokens = sessionStorage.getItem('bazarkely-oauth-tokens');
                
                if (pwaPrompt) {
                    const data = JSON.parse(pwaPrompt);
                    log('‚úÖ Donn√©es PWA trouv√©es dans sessionStorage: ' + JSON.stringify(data, null, 2));
                    updateStatus('pwa-status', 'success', '‚úÖ Donn√©es PWA pr√©-captur√©es trouv√©es');
                } else {
                    log('‚ÑπÔ∏è Aucune donn√©e PWA dans sessionStorage');
                }
                
                if (oauthTokens) {
                    log('‚úÖ Tokens OAuth trouv√©s dans sessionStorage');
                } else {
                    log('‚ÑπÔ∏è Aucun token OAuth dans sessionStorage');
                }
                
                // Lister toutes les cl√©s
                const allKeys = Object.keys(sessionStorage);
                log('üìã Toutes les cl√©s sessionStorage: ' + allKeys.join(', '));
                
            } catch (error) {
                log('‚ùå Erreur lors de la v√©rification du sessionStorage: ' + error.message);
            }
        }

        function clearSessionStorage() {
            log('üßπ Nettoyage du sessionStorage...');
            sessionStorage.removeItem('bazarkely-pwa-prompt');
            sessionStorage.removeItem('bazarkely-oauth-tokens');
            log('‚úÖ sessionStorage nettoy√©');
            updateStatus('pwa-status', 'info', '‚ÑπÔ∏è sessionStorage nettoy√©');
        }

        function testInstallButton() {
            log('üîò Test du bouton d\'installation...');
            
            try {
                const previewFrame = document.getElementById('preview-frame');
                const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                // Chercher le bouton d'installation
                const installButton = iframeDoc.querySelector('button[onclick*="install"], button:contains("Installer")');
                if (installButton) {
                    log('‚úÖ Bouton d\'installation trouv√©');
                    updateStatus('pwa-status', 'success', '‚úÖ Bouton d\'installation d√©tect√©');
                } else {
                    log('‚ö†Ô∏è Bouton d\'installation non trouv√©');
                    updateStatus('pwa-status', 'warning', '‚ö†Ô∏è Bouton d\'installation non trouv√©');
                }
            } catch (error) {
                log('‚ùå Impossible de tester le bouton d\'installation: ' + error.message);
                updateStatus('pwa-status', 'warning', '‚ö†Ô∏è Test du bouton limit√© par CORS');
            }
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, type, message) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        // V√©rification p√©riodique du serveur
        setInterval(checkServerStatus, 30000); // Toutes les 30 secondes
    </script>
</body>
</html>









